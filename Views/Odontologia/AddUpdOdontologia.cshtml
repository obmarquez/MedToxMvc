@model MedToxMVC.Models.Odontologias.OdontologiasModel

@{
    ViewData["Title"] = "AddUpdOdontologia";
}

<div class="row">

    <div class="col-lg-12">

        <div class="tabs-container">

            <ul class="nav nav-tabs">

                <li class="active"><a data-toggle="tab" href="#tabNutricion"> Datos de la Evaluacion</a></li>
                <li><a data-toggle="tab" href="#tabTatuajeDental"> Tatuaje Dental</a></li>
                <li><a data-toggle="tab" href="#tabObservacion"> Observaciones</a></li>

            </ul>

            <div class="tab-content">

                @*Datos de la evaluacion*@
                <div id="tabNutricion" class="tab-pane active">

                    <div class="ibox">

                        <div class="ibox-title">

                            <h5>Evaluación Odontológica</h5> <small>Evaluado</small>

                        </div>

                        <form asp-controller="Odontologia" asp-action="GrabarActualizarOdontologia" id="myForm" role="form" data-toggle="validator" method="post" accept-charset="utf-8" class="form-horizontal">

                            <div class="ibox-content">

                                <input type="hidden" value="@ViewBag.accion" id="accion" name="accion" />
                                <input type="hidden" value="@ViewBag.idhistorico" id="idhistorico" name="idhistorico" />
                                <input type="hidden" value="@ViewBag.fechaaceptacion" id="f_registro" name="f_registro" />

                                <div class="row">

                                    <div class="col-lg-6">

                                        <div class="panel panel-info">

                                            <div class="panel-heading">

                                                <i class="fa fa-medkit"></i> ATM

                                            </div>

                                            <div class="panel-body">

                                                @Html.TextArea("od_atm", new { @id = "od_atm", @class = "form-control", rows = 3 })

                                            </div>

                                        </div>

                                    </div>

                                    <div class="col-lg-6">

                                        <div class="panel panel-info">

                                            <div class="panel-heading">

                                                <i class="fa fa-medkit"></i> Labios

                                            </div>

                                            <div class="panel-body">

                                                @Html.TextArea("od_labios", new { @id = "od_labios", @class = "form-control", rows = 3 })

                                            </div>

                                        </div>

                                    </div>

                                </div>

                                <div class="row">

                                    <div class="col-lg-6">

                                        <div class="panel panel-info">

                                            <div class="panel-heading">

                                                <i class="fa fa-medkit"></i> Paladar

                                            </div>

                                            <div class="panel-body">

                                                @Html.TextArea("od_paladar", new { @id = "od_paladar", @class = "form-control", rows = 3 })

                                            </div>

                                        </div>

                                    </div>

                                    <div class="col-lg-6">

                                        <div class="panel panel-info">

                                            <div class="panel-heading">

                                                <i class="fa fa-medkit"></i> Carrillos

                                            </div>

                                            <div class="panel-body">

                                                @Html.TextArea("od_carrillos", new { @id = "od_carrillos", @class = "form-control", rows = 3 })

                                            </div>

                                        </div>

                                    </div>

                                </div>

                                <div class="row">

                                    <div class="col-lg-6">

                                        <div class="panel panel-info">

                                            <div class="panel-heading">

                                                <i class="fa fa-medkit"></i> Istmo de las Fauces

                                            </div>

                                            <div class="panel-body">

                                                @Html.TextArea("od_istmo", new { @id = "od_istmo", @class = "form-control", rows = 3 })

                                            </div>

                                        </div>

                                    </div>

                                    <div class="col-lg-6">

                                        <div class="panel panel-info">

                                            <div class="panel-heading">

                                                <i class="fa fa-medkit"></i> Lengua

                                            </div>

                                            <div class="panel-body">

                                                @Html.TextArea("od_lengua", new { @id = "od_lengua", @class = "form-control", rows = 3 })

                                            </div>

                                        </div>

                                    </div>

                                </div>

                                <div class="row">

                                    <div class="col-lg-6">

                                        <div class="panel panel-info">

                                            <div class="panel-heading">

                                                <i class="fa fa-medkit"></i> Piso de la Boca

                                            </div>

                                            <div class="panel-body">

                                                @Html.TextArea("od_piso_boca", new { @id = "od_piso_boca", @class = "form-control", rows = 3 })

                                            </div>

                                        </div>

                                    </div>

                                    <div class="col-lg-6">

                                        <div class="panel panel-info">

                                            <div class="panel-heading">

                                                <i class="fa fa-medkit"></i> Encía

                                            </div>

                                            <div class="panel-body">

                                                @Html.TextArea("od_encia", new { @id = "od_encia", @class = "form-control", rows = 3 })

                                            </div>

                                        </div>

                                    </div>

                                </div>

                                <div class="row">

                                    <div class="col-lg-6">

                                        <div class="panel panel-info">

                                            <div class="panel-heading">

                                                <i class="fa fa-medkit"></i> Diente

                                            </div>

                                            <div class="panel-body">

                                                @Html.TextArea("od_diente", new { @id = "od_diente", @class = "form-control", rows = 3 })

                                            </div>

                                        </div>

                                    </div>

                                    <div class="col-lg-6">

                                        <div class="panel panel-info">

                                            <div class="panel-heading">

                                                <i class="fa fa-slack"></i> Ausentes - Obturados - Reemplazados - Cariados - Oclusión

                                            </div>

                                            <div class="panel-body">

                                                <div class="form-group">

                                                    <div class="col-lg-6">

                                                        <label class="col-lg-7 control-label">Ausente</label>
                                                        <div class="col-lg-5">@Html.TextBoxFor(model => model.od_ausentes, new { @class = "form-control" })</div>

                                                    </div>

                                                    <div class="col-lg-6">

                                                        <label class="col-lg-7 control-label">Obturados</label>
                                                        <div class="col-lg-5">@Html.TextBoxFor(model => model.od_obturados, new { @class = "form-control" })</div>

                                                    </div>

                                                </div>

                                                <div class="form-group">

                                                    <div class="col-lg-6">

                                                        <label class="col-lg-7 control-label">Reemplazados</label>
                                                        <div class="col-lg-5">@Html.TextBoxFor(model => model.od_reemplezados, new { @class = "form-control" })</div>

                                                    </div>

                                                    <div class="col-lg-6">

                                                        <label class="col-lg-7 control-label">Cariados</label>
                                                        <div class="col-lg-5">@Html.TextBoxFor(model => model.od_perdidos, new { @class = "form-control" })</div>

                                                    </div>

                                                </div>

                                                <div class="form-group">

                                                    <div class="col-lg-12">

                                                        <label class="col-lg-4 control-label">Tipo de Oclusión</label>
                                                        <div class="col-lg-8">@Html.DropDownListFor(model => model.od_tipooclusion, (IEnumerable<SelectListItem>)ViewBag.tipoOclusion, new { @id = "od_tipooclusion", @class = "form-control" })</div>

                                                    </div>


                                                </div>

                                            </div>

                                        </div>

                                    </div>

                                </div>

                                <div class="row">

                                    <div class="col-lg-6">

                                        <div class="panel panel-info">

                                            <div class="panel-heading">

                                                <i class="fa fa-medkit"></i> Observaciones

                                            </div>

                                            <div class="panel-body">

                                                @Html.TextArea("od_observa", new { @id = "od_observa", @class = "form-control", rows = 3 })

                                            </div>

                                        </div>

                                    </div>

                                    <div class="col-lg-6">

                                        <div class="panel panel-info">

                                            <div class="panel-heading">

                                                <i class="fa fa-medkit"></i> Recomendación

                                            </div>

                                            <div class="panel-body">

                                                @Html.TextArea("recomendacion", new { @id = "recomendacion", @class = "form-control", rows = 3 })

                                            </div>

                                        </div>

                                    </div>

                                </div>

                                <div class="row">

                                    <div class="col-lg-12">

                                        <div class="panel panel-info">

                                            <div class="panel-heading">

                                                <i class="fa fa-medkit"></i> Diagnóstico

                                            </div>

                                            <div class="panel-body">

                                                @Html.TextArea("diagnostico", new { @id = "diagnostico", @class = "form-control", rows = 3 })

                                            </div>

                                        </div>

                                    </div>

                                </div>

                            </div>

                            <div class="ibox-footer">

                                <button class="btn btn-outline btn-success  dim" type="submit"><i class="fa fa-floppy-o"></i></button>
                                <button class="btn btn-outline btn-danger  dim " type="button" onclick="salir();"><i class="fa fa-sign-out"></i></button>

                            </div>

                        </form>

                    </div>

                </div>

                <div id="tabTatuajeDental" class="tab-pane">

                    <div class="wrapper wrapper-content animated">

                        <div class="row">

                            <div class="col-lg-12 col-md-12 col-sm-12">

                                <div class="ibox">

                                    <div class="ibox-title">

                                        <h5>Toma de imagenes dentales</h5>

                                    </div>

                                    <div class="ibox-content">

                                        <div class="row">

                                            <div class="col-lg-6">

                                                <video id="video" width="640" height="480" autoplay></video>
                                                <button id="snap">Tomar Foto</button>

                                            </div>

                                            <div class="col-lg-6">

                                                @*<canvas id="canvas" width="640" height="480"></canvas>*@
                                                <canvas id="canvas" width="320" height="240"></canvas>

                                            </div>

                                        </div>

                                        <div class="row">

                                            <div class="col-lg-12">

                                                <label class="control-label">Descripción de la Imagen</label>
                                                <div>
                                                    @Html.TextArea("descripcion", new { @id = "descripcion", @class = "form-control", rows = 2 })
                                                </div>

                                            </div>

                                        </div>

                                    </div>

                                    <div class="ibox-footer">
                                        <button class="btn btn-outline btn-success  dim" type="submit" onclick="convertCanvasToImage(canvas)"><i class="fa fa-floppy-o"></i></button>
                                    </div>

                                </div>

                            </div>

                        </div>

                    </div>

                    @*<video id="video" width="640" height="480" autoplay></video>
                        <button id="snap">Snap Photo</button>
                        <canvas id="canvas" width="640" height="480"></canvas>*@

                </div>

                <div id="tabObservacion" class="tab-pane">

                    <div class="wrapper wrapper-content animated">

                        <div class="row">

                            <div class="col-lg-12 col-md-12 col-sm-12">

                                <div class="ibox">

                                    <div class="ibox-title">

                                        <h5>Observaciones Publica y Custodia</h5>

                                    </div>

                                    <div class="ibox-content">

                                        <div class="row">

                                            <div class="col-lg-12 col-md-12 col-sm-12">

                                                <div class="panel panel-default">

                                                    <div class="panel-heading">

                                                        <i class="fa fa-pencil-square-o"></i> Observaciones Pública

                                                    </div>

                                                    <div class="panel-body">

                                                        <table class="table table-striped table-bordered" style="font-size:small">

                                                            <thead>

                                                                <tr>

                                                                    <th>AREA</th>
                                                                    <th>FECHA</th>
                                                                    <th>OBSERVACION</th>

                                                                </tr>

                                                            </thead>

                                                            <tbody>

                                                                @foreach (var itemObs in ViewBag.ObservacionesPublicas)
                                                                {
                                                                    <tr>
                                                                        <td>@itemObs.area</td>
                                                                        <td>@itemObs.fecha</td>
                                                                        <td>@itemObs.observacion</td>
                                                                    </tr>
                                                                }

                                                            </tbody>

                                                        </table>

                                                    </div>

                                                </div>

                                            </div>

                                        </div>

                                        <div class="form-group">

                                            <label>Nueva Observación</label>

                                            @Html.TextArea("Observacionpublica", new { @id = "Observacionpublica", @class = "form-control", rows = 2 })

                                        </div>

                                        <div class="row">

                                            <div class="col-lg-12 col-md-12 col-sm-12">

                                                <div class="panel panel-default">

                                                    <div class="panel-heading">

                                                        <i class="fa fa-pencil-square-o"></i> Observaciones Custodia

                                                    </div>

                                                    <div class="panel-body">

                                                        <table class="table table-striped table-bordered" style="font-size:small">

                                                            <thead>

                                                                <tr>

                                                                    <th>FECHA</th>
                                                                    <th>OBSERVACION</th>

                                                                </tr>

                                                            </thead>

                                                            <tbody>

                                                                @foreach (var itemObsCus in ViewBag.ObservacionCustodia)
                                                                {
                                                                    <tr>
                                                                        <td>@itemObsCus.fechaCus</td>
                                                                        <td>@itemObsCus.observacionCus</td>
                                                                    </tr>
                                                                }

                                                            </tbody>

                                                        </table>

                                                    </div>

                                                </div>

                                            </div>

                                        </div>

                                    </div>

                                    <div class="ibox-footer">

                                        <button type="button" class="btn btn-primary" onclick="grabarObservacionPublica();">Grabar Observación Pública</button>

                                    </div>

                                </div>

                            </div>

                        </div>

                    </div>

                </div>

            </div>

        </div>



    </div>

</div>

@section scripts
{
    @*-- css --*@
    <link href="~/css/plugins/sweetalert/sweetalert.css" rel="stylesheet" />

    @*-- js --*@
    <script src="~/js/plugins/sweetalert/sweetalert.min.js"></script>

    <script language="javascript">

        $(document).ready(function () {

            //llenando campos si es accion = 1
            if ($("#accion").val() == 1) {

                $("#od_atm").val("No presenta dolor a la palpación, apertura y cierre mandibular.");
                $("#od_labios").val("Medianos, humectados, simétricos, aparentemente sin datos patológicos.");
                $("#od_paladar").val("Mediano, presencia de línea media definida, rugas palatinas íntegras, foveola palatina pronunciada, sin lesión patológica.");
                $("#od_carrillos").val("Mucosa humectada, presencia de línea alba definida, conductos de Stenon presentes en ambos carrillos, sin lesión patológica.");
                $("#od_istmo").val("Amígdalas faríngeas se observan sin alteraciones patológicas.");
                $("#od_lengua").val("Color rosa, aspecto brillante y características clínicas normales.");
                $("#od_piso_boca").val("Frenillo lingual se encuentra bien adherido a la cara ventral de la lengua, conducto salival excretor de Wharton presente sin lesiones patológicas.");
                $("#od_encia").val("Color rosa coral, contorno de los espacios interproximales definidos, puntilleo característico y  consistencia firme.");
                $("#recomendacion").val("Se sugiere atención odontológica para realizar tratamiento de órganos dentarios afectados por caries dental, odontoxesis cada 6 meses.");
                $("#ob_observa").val("Ninguna.");
                $("#od_ausentes").val("0");
                $("#od_obturados").val("0");
                $("#od_reemplezados").val("0");
                $("#od_perdidos").val("0");

            }

            //------------------------------------------------------------------------------------- Usar WebCam
            // Grab elements, create settings, etc.
            var video = document.getElementById('video');

            // Get access to the camera!
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                // Not adding `{ audio: true }` since we only want video now
                navigator.mediaDevices.getUserMedia({ video: true }).then(function (stream) {
                    //video.src = window.URL.createObjectURL(stream);
                    video.srcObject = stream;
                    video.play();
                });
            }
             //Legacy code below: getUserMedia
                else if(navigator.getUserMedia) { // Standard
                    navigator.getUserMedia({ video: true }, function(stream) {
                        video.src = stream;
                        video.play();
                    }, errBack);
                } else if(navigator.webkitGetUserMedia) { // WebKit-prefixed
                    navigator.webkitGetUserMedia({ video: true }, function(stream){
                        video.src = window.webkitURL.createObjectURL(stream);
                        video.play();
                    }, errBack);
                } else if(navigator.mozGetUserMedia) { // Mozilla-prefixed
                    navigator.mozGetUserMedia({ video: true }, function(stream){
                        video.srcObject = stream;
                        video.play();
                    }, errBack);
                }
                

            // Elements for taking the snapshot
            var canvas = document.getElementById('canvas');
            var context = canvas.getContext('2d');
            var video = document.getElementById('video');

            // Trigger photo take
            document.getElementById("snap").addEventListener("click", function () {
                /*context.drawImage(video, 0, 0, 640, 480);*/
                context.drawImage(video, 0, 0, 320, 240);
            });
            //------------------------------------------------------------------------------------- Usar WebCam

        });

        function convertCanvasToImage(canvas) {
            //---------------------------------------------------------------------------------------------- 1
            ////alert("Aqui entro");
            //var image = new Image();
            //image.src = canvas.toDataURL("image/png");
            ////alert(image.src);
            //return image;

            //---------------------------------------------------------------------------------------------- 2
            //alert("Entro 2a Parte");
            //--------------------------------------------------------------------- grabando imagen como formato png
            //var image = document.getElementById("canvas").toDataURL("image/ong");

            //--------------------------------------------------------------------- grabando imagen como formato jpg
            var image = document.getElementById("canvas").toDataURL("image/jpg");
            image = image.replace('data:image/png;base64,', '');
            var idhis = $("#idhistorico").val();
            var _descripcion = $("#descripcion").val();
            $.ajax({
                type: 'POST',
                url: "@Url.Action("CrearFoto", "Odontologia")",
                //contentType: 'application/json; charset=utf-8',
                dataType: 'json',
                data: { imageData: image, idhistorico: idhis, descripcion: _descripcion },
                success: function (data) {

                    alert('Image saved successfully !');

                }
            });
        }

        function grabarObservacionPublica() {
            //alert("IdHistorico: " + $('#idhistorico').val() + " " + $('#Observacionpublica').val());
            var _idHistoricoObservacion = $('#idhistorico').val();
            var _laObservaciones = $('#Observacionpublica').val();

            if (_laObservaciones == "") {

                swal("Debe indicar la observación", "Verifique campo", "error");

            }
            else {

                var url = "@Url.Action("js_agregar_observacion", "Observacion")";
                var data = { p_idHistorico: _idHistoricoObservacion, p_observacionPublica: _laObservaciones };
                $.post(url, data).done(function (data) {
                    if (data == "Ok") {
                        swal({
                            title: "Observación Agregada Satisfactoeriamente",
                            text: "Click para continuar y F5 para actualizar",
                            type: "success"
                        });
                    }
                }).fail(manejarErrorAjax);

            }
        }

        function salir() {
            location.href = '@Url.Action("IndexOdontologia", "Odontologia")';
        }

    </script>
}